<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dili.uap.dao.MenuMapper">
  <resultMap id="BaseResultMap" type="com.dili.uap.domain.Menu">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    <result column="system_id" jdbcType="BIGINT" property="systemId" />
    <result column="order_number" jdbcType="INTEGER" property="orderNumber" />
    <result column="url" jdbcType="VARCHAR" property="url" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="target" jdbcType="INTEGER" property="target" />
    <result column="created" jdbcType="TIMESTAMP" property="created" />
    <result column="modified" jdbcType="TIMESTAMP" property="modified" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="icon_cls" jdbcType="VARCHAR" property="iconCls" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
    -->
    id, parent_id, system_id, order_number, url, name, description, target, created, modified, type,
    icon_cls
  </sql>
  <select id="selectBy" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
    -->
    select 
    <include refid="Base_Column_List" />
    from menu
    where id = #{id,jdbcType=BIGINT}
  </select>


  <!-- ============================== SQL分割线 ============================== -->

  <sql id="column_List">
    m.id
    ,m.parent_id
    ,m.system_id
    ,m.order_number
    ,m.url
    ,m.`name`
    ,m.description
    ,m.target
    ,m.created
    ,m.modified
    ,m.icon_cls
    ,m.`type`
  </sql>

  <!--根据用户id查询所有菜单 -->
  <select id="listByUserId" parameterType="Long" resultMap="BaseResultMap">
    SELECT DISTINCT
    <include refid="column_List" />
    from menu m, role_menu rm, user_role ur
    where m.id = rm.menu_id
    and rm.role_id = ur.role_id
    and ur.user_id = #{userId}
    order by m.order_number
  </select>

  <!--根据用户id查询目录和链接菜单 -->
  <select id="listDirAndLinksByUserId" parameterType="Long" resultMap="BaseResultMap">
    SELECT DISTINCT
    <include refid="column_List" />
    from menu m, role_menu rm, user_role ur
    where m.id = rm.menu_id
    and rm.role_id = ur.role_id
    and ur.user_id = #{userId}
    and (m.`type` = 0 or m.`type` = 1)
    order by m.order_number
  </select>

  <!-- 查询上级菜单 -->
  <select id="getParentMenus" parameterType="java.lang.String" resultType="string">
    select getParentMenus(#{id})
  </select>

  <sql id="Dto_Column_List">
		m.id,
		m.system_id,
		m.parent_id,
		m.order_number,
		m.url,
		m.`name`,
		m.description,
		m.target,
		m.created,
		m.modified,
		m.type,
		r.id AS resource_id,
		r.`name` AS
		resource_name,
		r.description AS resource_description,
		r.menu_id,
		r.created AS resource_created,
		r.modified AS resource_modified
	</sql>

  <resultMap id="DtoResultMap" type="com.dili.uap.domain.dto.MenuDto">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="system_id" jdbcType="BIGINT" property="systemId" />
    <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    <result column="order_number" jdbcType="INTEGER" property="orderNumber" />
    <result column="url" jdbcType="VARCHAR" property="url" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="target" jdbcType="INTEGER" property="target" />
    <result column="created" jdbcType="TIMESTAMP" property="created" />
    <result column="modified" jdbcType="TIMESTAMP" property="modified" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <collection ofType="com.dili.uap.domain.Resource" property="resources">
      <id column="resource_id" jdbcType="BIGINT" property="id" />
      <result column="resource_name" jdbcType="VARCHAR" property="name" />
      <result column="resource_description" jdbcType="VARCHAR" property="description" />
      <result column="menu_id" jdbcType="BIGINT" property="menuId" />
      <result column="resource_created" jdbcType="TIMESTAMP" property="created" />
      <result column="resource_modified" jdbcType="TIMESTAMP" property="modified" />
    </collection>
  </resultMap>
  <select id="selectMenuDto" parameterType="Long" resultMap="DtoResultMap">
    SELECT
    <include refid="Dto_Column_List" />
    FROM
    menu m
    LEFT JOIN resource
    r ON m.id = r.menu_id
  </select>
</mapper>